/**
 * @file MDFlexMPI.cpp
 * @author J. KÃ¶rner
 * @date 07.04.2021
 */

#include "MDFlexMPI.h"

#include <algorithm>
#include <iostream>

#include "autopas/utils/ArrayMath.h"

MDFlexMPI::MDFlexMPI(int dimensionCount, int argc, char **argv) {
  MDFlexSimulation::initialize(dimensionCount, argc, argv);
}

void MDFlexMPI::run() {
  // @todo: make variable part of MDFlexConfig
  int iterationsPerSuperstep = 1;
  int remainingIterations = _configuration->iterations.value;

  for (int i = 0; i < _configuration->iterations.value; i += iterationsPerSuperstep) {
    executeSuperstep(iterationsPerSuperstep);
  }
}

void MDFlexMPI::executeSuperstep(const int iterationsPerSuperstep) {
  _domainDecomposition->exchangeHaloParticles(_autoPasContainer);

<<<<<<< Updated upstream
  for (int i = 1; i < iterationsPerSuperstep; ++i) {
=======
  for (int i = 0; i < iterationsPerSuperstep; ++i) {
    if (_createVtkFiles and _iteration % _configuration->vtkWriteFrequency.value == 0) {
      _vtkWriter->recordTimestep(_iteration, _maximumIterationDigits, *_autoPasContainer);
    }

    ++_iteration;
>>>>>>> Stashed changes
    updateParticles();
  }

  // todo: Not sure if this synchronization is required. Check performance with and without it.
  _domainDecomposition->synchronizeDomains();

  _domainDecomposition->exchangeMigratingParticles(_autoPasContainer);
}

void MDFlexMPI::updateParticles() {
  updatePositions();
  updateForces();
  updateVelocities();
}

void MDFlexMPI::initializeDomainDecomposition(int &dimensionCount) {
  std::vector<double> boxMin(_configuration->boxMin.value.begin(), _configuration->boxMin.value.end());
  std::vector<double> boxMax(_configuration->boxMax.value.begin(), _configuration->boxMax.value.end());

  _domainDecomposition = std::make_shared<RegularGrid>(dimensionCount, boxMin, boxMax);

  std::vector<double> localBoxMin = _domainDecomposition->getLocalBoxMin();
  std::vector<double> localBoxMax = _domainDecomposition->getLocalBoxMax();
  for (int i = 0; i < localBoxMin.size(); ++i) {
    _configuration->boxMin.value[i] = localBoxMin[i];
    _configuration->boxMax.value[i] = localBoxMax[i];
  }
}
